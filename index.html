<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Node.js Server</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        text-align: center;
      }
      h1 {
        color: #333;
      }
      img {
        width: 200px;
        height: auto;
      }
      #loader {
        display: none;
        text-align: center;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container" id="content">
      <h1>Hello from Node.js Server!</h1>
      <p>This is a simple HTML page served by Node.js, with an image and PDF export functionality.</p>
      <!-- Image hosted locally, update src to your local image -->
      <img id="exampleImage" src="/image.png" alt="Example Image" />
    </div>

    <button id="download">Download PDF</button>
    <div id="loader">Generating PDF, please wait...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script>
      document.getElementById('download').addEventListener('click', async function () {
        const loader = document.getElementById('loader');
        loader.style.display = 'block'; // Show loader

        try {
          // Ensure the image is fully loaded before converting
          await ensureImageLoaded('exampleImage');

          const element = document.getElementById('content');

          // Directly convert the HTML content to PDF using html2pdf
          html2pdf()
            .set({
              margin: 1,
              filename: 'converted-page.pdf',
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: {
                scale: 2, // High scale for better quality
                useCORS: true, // Enable CORS to load cross-origin images
              },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
            })
            .from(element)
            .save();
        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('Failed to generate PDF. Please try again.');
        } finally {
          loader.style.display = 'none'; // Hide loader
        }
      });

      // Helper function to ensure the image is loaded before PDF generation
      function ensureImageLoaded(imageId) {
        const img = document.getElementById(imageId);
        return new Promise((resolve, reject) => {
          if (img.complete && img.naturalHeight !== 0) {
            resolve();
          } else {
            img.onload = resolve;
            img.onerror = () => reject(new Error('Image failed to load'));
          }
        });
      }
    </script>
  </body>
</html>
